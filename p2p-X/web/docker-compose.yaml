services:
  lesson:
    build:
      context: ${PROJECT_ROOT:-../..}
      dockerfile: ${LESSON_PATH:-en/js/08-final-checkpoint}/app/Dockerfile
      args:
        LESSON_PATH: ${LESSON_PATH:-en/js/08-final-checkpoint}
    container_name: 08-final-checkpoint-lesson
    stop_grace_period: 1m
    environment:
      - TIMEOUT_DURATION=${TIMEOUT_DURATION:-60}
      - INTERACTIVE=false
      - NODE_ENV=production
      - REMOTE_PEER=/ip4/172.16.16.17/tcp/9091
    volumes:
      - ${PROJECT_ROOT:-../..}/${LESSON_PATH:-en/js/08-final-checkpoint}/stdout.log:/workspace/stdout.log
    networks:
      workshop-net:
        ipv4_address: 172.16.16.16
    command: ["sh", "-c", "sleep 5 && node index.js > /workspace/stdout.log 2>&1"]
    depends_on:
      checker:
        condition: service_started

  checker:
    image: ghcr.io/libp2p/universal-connectivity-workshop/ucw-checker-en:latest
    container_name: 08-final-checkpoint-checker
    stop_grace_period: 1m
    environment:
      - TIMEOUT_DURATION=${TIMEOUT_DURATION:-180}
      - LISTEN_ADDRS=${LISTEN_ADDRS:-/ip4/0.0.0.0/tcp/9091}
      - INTERACTIVE=${INTERACTIVE:-false}
      - CHATTY=${CHATTY:-true}
    volumes:
      - ./checker.log:/app/checker.log
      - ${CHECKER_KEY_PATH:-${PROJECT_ROOT:-../..}/en/checker/keys/checker.key}:/app/key:ro
    command: ["/bin/sh", "-c", "timeout ${TIMEOUT_DURATION:-180} /app/checker > /app/checker.log 2>&1"]
    networks:
      workshop-net:
        ipv4_address: 172.16.16.17
    ports:
      - "9091:9091"  # Expose checker port for students to dial
networks:
  workshop-net:
    name: workshop-net
    external: true
